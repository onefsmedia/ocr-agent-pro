<div class="text-center mb-4">
    <h6 class="text-dark">Upload documents for OCR processing</h6>
</div>

<form id="upload-form" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="document-name" class="form-label text-dark">Document Name:</label>
        <input type="text" class="form-control" id="document-name" name="document_name" placeholder="Enter document name">
    </div>
    
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="document-type" class="form-label text-dark">Document Type:</label>
            <select class="form-select" id="document-type" name="document_type" required>
                <option value="">Select Type</option>
                <option value="curriculum">Curriculum</option>
                <option value="textbook">Textbook</option>
                <option value="progression">Progression Document</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="document-subject" class="form-label text-dark">Subject:</label>
            <select class="form-select" id="document-subject" name="subject">
                <option value="">Select Subject</option>
                <!-- Will be populated by JavaScript -->
            </select>
        </div>
        <div class="col-md-4">
            <label for="document-class" class="form-label text-dark">Class Level:</label>
            <select class="form-select" id="document-class" name="class_level">
                <option value="">Select Class</option>
                <!-- Will be populated by JavaScript -->
            </select>
        </div>
    </div>
    
    <div class="mb-3">
        <label for="file-input" class="form-label text-dark">Upload Document:</label>
        <input type="file" class="form-control" id="file-input" name="file" 
               accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp" required>
        <div class="form-text text-dark">Supported formats: PDF, PNG, JPG, JPEG, TIFF, BMP</div>
    </div>
    
    <div class="d-grid">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-upload me-2"></i>Upload & Process
        </button>
    </div>
</form>

<!-- Upload Progress -->
<div id="upload-progress" class="mt-3" style="display: none;">
    <div class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" style="width: 0%"></div>
    </div>
    <small class="text-dark mt-1 d-block">Processing document...</small>
</div>

<!-- Upload Result -->
<div id="upload-result" class="mt-3"></div>

<script>
// Load subjects and class levels when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSubjects();
    loadClassLevels();
});

function loadSubjects() {
    fetch('/api/subjects')
        .then(response => response.json())
        .then(data => {
            const subjectSelect = document.getElementById('document-subject');
            const dashboardSubjectSelect = document.getElementById('dashboard-subject');
            
            // Clear existing options (keep first option)
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            if (dashboardSubjectSelect) {
                dashboardSubjectSelect.innerHTML = '<option value="">Select Subject</option>';
            }
            
            if (data.subjects) {
                // Group subjects by category
                const categories = {
                    'science': 'ðŸ”¬ Sciences',
                    'languages': 'ðŸ—£ï¸ Languages & Literature',
                    'humanities': 'ðŸ“œ Humanities & Social Sciences',
                    'technical': 'ðŸ”§ Technical & Vocational',
                    'arts': 'ðŸŽ¨ Arts & Creative Studies'
                };
                
                // Function to add option group
                function addSubjectGroup(selectElement, groupLabel, subjects) {
                    if (subjects.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = groupLabel;
                        
                        subjects.forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject.name;
                            option.textContent = subject.name;
                            optgroup.appendChild(option);
                        });
                        
                        selectElement.appendChild(optgroup);
                    }
                }
                
                // Add subjects grouped by category
                Object.keys(categories).forEach(category => {
                    const categorySubjects = data.subjects.filter(subject => subject.category === category);
                    categorySubjects.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically
                    
                    addSubjectGroup(subjectSelect, categories[category], categorySubjects);
                    
                    if (dashboardSubjectSelect) {
                        addSubjectGroup(dashboardSubjectSelect, categories[category], categorySubjects);
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading subjects:', error);
        });
}

function loadClassLevels() {
    fetch('/api/class-levels')
        .then(response => response.json())
        .then(data => {
            const classSelect = document.getElementById('document-class');
            const dashboardClassSelect = document.getElementById('dashboard-class');
            
            // Clear existing options (keep first option)
            classSelect.innerHTML = '<option value="">Select Class Level</option>';
            if (dashboardClassSelect) {
                dashboardClassSelect.innerHTML = '<option value="">Select Class Level</option>';
            }
            
            if (data.class_levels) {
                // Group by education level and section for better organization
                const primary_english = data.class_levels.filter(level => 
                    level.education_level === 'primary' && level.education_section === 'english'
                );
                const primary_french = data.class_levels.filter(level => 
                    level.education_level === 'primary' && level.education_section === 'french'
                );
                const secondary1_english = data.class_levels.filter(level => 
                    level.education_level === 'secondary_first_cycle' && level.education_section === 'english'
                );
                const secondary1_french = data.class_levels.filter(level => 
                    level.education_level === 'secondary_first_cycle' && level.education_section === 'french'
                );
                const secondary2_english = data.class_levels.filter(level => 
                    level.education_level === 'secondary_second_cycle' && level.education_section === 'english'
                );
                const secondary2_french = data.class_levels.filter(level => 
                    level.education_level === 'secondary_second_cycle' && level.education_section === 'french'
                );
                
                // Function to add option group
                function addOptionGroup(selectElement, groupLabel, levels) {
                    if (levels.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = groupLabel;
                        
                        levels.forEach(level => {
                            const option = document.createElement('option');
                            option.value = level.name;
                            option.textContent = level.name;
                            optgroup.appendChild(option);
                        });
                        
                        selectElement.appendChild(optgroup);
                    }
                }
                
                // Add organized option groups
                addOptionGroup(classSelect, 'ðŸ“š Primary - English Section', primary_english);
                addOptionGroup(classSelect, 'ðŸ“š Primary - French Section', primary_french);
                addOptionGroup(classSelect, 'ðŸŽ“ Secondary 1st Cycle - English', secondary1_english);
                addOptionGroup(classSelect, 'ðŸŽ“ Secondary 1st Cycle - French', secondary1_french);
                addOptionGroup(classSelect, 'ðŸŽ¯ Secondary 2nd Cycle - English', secondary2_english);
                addOptionGroup(classSelect, 'ðŸŽ¯ Secondary 2nd Cycle - French', secondary2_french);
                
                // Do the same for dashboard select if it exists
                if (dashboardClassSelect) {
                    addOptionGroup(dashboardClassSelect, 'ðŸ“š Primary - English Section', primary_english);
                    addOptionGroup(dashboardClassSelect, 'ðŸ“š Primary - French Section', primary_french);
                    addOptionGroup(dashboardClassSelect, 'ðŸŽ“ Secondary 1st Cycle - English', secondary1_english);
                    addOptionGroup(dashboardClassSelect, 'ðŸŽ“ Secondary 1st Cycle - French', secondary1_french);
                    addOptionGroup(dashboardClassSelect, 'ðŸŽ¯ Secondary 2nd Cycle - English', secondary2_english);
                    addOptionGroup(dashboardClassSelect, 'ðŸŽ¯ Secondary 2nd Cycle - French', secondary2_french);
                }
            }
        })
        .catch(error => {
            console.error('Error loading class levels:', error);
        });
}

document.getElementById('upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const fileInput = document.getElementById('file-input');
    const nameInput = document.getElementById('document-name');
    const typeInput = document.getElementById('document-type');
    const progressDiv = document.getElementById('upload-progress');
    const resultDiv = document.getElementById('upload-result');
    
    // Validate inputs
    if (!fileInput.files[0]) {
        showAlert('Please select a file to upload.', 'warning');
        return;
    }
    
    if (!typeInput.value) {
        showAlert('Please select a document type.', 'warning');
        return;
    }
    
    // Set document name if not provided
    if (!nameInput.value.trim()) {
        nameInput.value = fileInput.files[0].name;
        formData.set('document_name', fileInput.files[0].name);
    }
    
    // Show progress
    progressDiv.style.display = 'block';
    resultDiv.innerHTML = '';
    
    // Upload file
    fetch('/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressDiv.style.display = 'none';
        
        if (data.error) {
            showAlert(data.error, 'danger');
        } else {
            const typeText = typeInput.options[typeInput.selectedIndex].text;
            const subjectText = document.getElementById('document-subject').value || 'Unspecified';
            const classText = document.getElementById('document-class').value || 'Unspecified';
            
            showAlert(`${typeText} processed successfully! Created ${data.chunks_created} text chunks.\\nSubject: ${subjectText}, Class: ${classText}`, 'success');
            // Reset form
            document.getElementById('upload-form').reset();
            // Refresh dashboard if we're on it
            if (typeof refreshDashboard === 'function') {
                refreshDashboard();
            }
        }
    })
    .catch(error => {
        progressDiv.style.display = 'none';
        showAlert('Upload failed: ' + error.message, 'danger');
    });
});

function showAlert(message, type) {
    const resultDiv = document.getElementById('upload-result');
    resultDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}
</script>