{% extends "base.html" %}

{% block title %}System Settings - OCR Agent Pro{% endblock %}

{% block content %}
<style>
.clickable {
    cursor: pointer;
    transition: all 0.2s ease;
}

.clickable:hover {
    transform: scale(1.05);
    opacity: 0.8;
}

#prompt-categories .list-group-item {
    cursor: pointer;
    transition: all 0.2s ease;
}

#prompt-categories .list-group-item:hover {
    background-color: #f8f9fa;
}

#prompt-categories .list-group-item.active {
    background-color: #0d6efd;
    color: white;
}

.config-card-hover:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#test-results-settings {
    max-height: 200px;
    overflow-y: auto;
}
</style>

<!-- Enhanced Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card glass-effect border-0 mb-4 animate__animated animate__fadeInDown">
            <div class="card-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-cogs fa-3x gradient-text"></i>
                </div>
                <h1 class="gradient-text mb-2">System Configuration</h1>
                <p class="text-muted mb-3">Customize your OCR Agent experience</p>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Settings Tabs -->
<div class="card border-0 shadow-sm">
    <div class="card-header border-0 bg-white">
        <ul class="nav nav-pills nav-fill" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active rounded-pill mx-1" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab">
                    <i class="fas fa-database me-2"></i>Database
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill mx-1" id="ocr-tab" data-bs-toggle="tab" data-bs-target="#ocr" type="button" role="tab">
                    <i class="fas fa-eye me-2"></i>OCR Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill mx-1" id="onlyoffice-tab" data-bs-toggle="tab" data-bs-target="#onlyoffice" type="button" role="tab">
            <i class="fas fa-file-office"></i> OnlyOffice
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill mx-1" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button" role="tab">
            <i class="fas fa-robot"></i> AI/LLM
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill mx-1" id="prompts-tab" data-bs-toggle="tab" data-bs-target="#prompts" type="button" role="tab">
            <i class="fas fa-magic me-2"></i>AI Prompts
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill mx-1" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
            <i class="fas fa-server"></i> System
        </button>
    </li>
</ul>

<div class="tab-content" id="settingsTabContent">
    
    <!-- Database Settings -->
    <div class="tab-pane fade show active" id="database" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-database"></i> Database Configuration</h5>
            </div>
            <div class="card-body">
                <form id="database-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="db-host" class="form-label">Database Host</label>
                                <input type="text" class="form-control" id="db-host" name="database_host" 
                                       value="{{ settings.get('database_host', 'localhost') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="db-port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="db-port" name="database_port" 
                                       value="{{ settings.get('database_port', '5432') }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="db-name" class="form-label">Database Name</label>
                                <input type="text" class="form-control" id="db-name" name="database_name" 
                                       value="{{ settings.get('database_name', 'ocr_agent') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="db-user" class="form-label">Username</label>
                                <input type="text" class="form-control" id="db-user" name="database_user" 
                                       value="{{ settings.get('database_user', 'ocr_user') }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="db-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="db-password" name="database_password" 
                                       placeholder="Enter new password to change">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Connection Status</label>
                                <div class="form-control-plaintext">
                                    <span id="db-connection-status" class="badge bg-secondary">Testing...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info" onclick="testDatabaseConnection()">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Database Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- OCR Settings -->
    <div class="tab-pane fade" id="ocr" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-eye"></i> OCR Configuration</h5>
            </div>
            <div class="card-body">
                <form id="ocr-form">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-brain"></i> DeepSeek OCR (Primary)</h6>
                            
                            <!-- Local DeepSeek OCR -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-desktop"></i> Local Installation</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="use-deepseek" name="use_deepseek_ocr" 
                                                   {{ 'checked' if settings.get('use_deepseek_ocr', True) else '' }}>
                                            <label class="form-check-label" for="use-deepseek">
                                                Enable DeepSeek OCR
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="deepseek-path" class="form-label">Installation Path</label>
                                        <input type="text" class="form-control" id="deepseek-path" name="deepseek_path" 
                                               value="{{ settings.get('deepseek_path', 'D:\\AIWORKS\\DeepSeek-OCR\\DeepSeek-OCR\\DeepSeek-OCR-master\\DeepSeek-OCR-vllm') }}">
                                        <div class="form-text">Path to local DeepSeek OCR installation</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="deepseek-env" class="form-label">Conda Environment</label>
                                        <input type="text" class="form-control" id="deepseek-env" name="deepseek_env" 
                                               value="{{ settings.get('deepseek_env', 'vllm_env') }}">
                                        <div class="form-text">Name of the conda environment</div>
                                    </div>
                                    <div class="d-flex gap-2 mb-3">
                                        <button type="button" class="btn btn-success btn-sm" onclick="startDeepSeekOCR()">
                                            <i class="fas fa-play"></i> Start Server
                                        </button>
                                        <button type="button" class="btn btn-warning btn-sm" onclick="stopDeepSeekOCR()">
                                            <i class="fas fa-stop"></i> Stop Server
                                        </button>
                                        <button type="button" class="btn btn-info btn-sm" onclick="checkDeepSeekStatus()">
                                            <i class="fas fa-heartbeat"></i> Check Status
                                        </button>
                                    </div>
                                    <div id="deepseek-status" class="alert alert-secondary mb-0">
                                        <i class="fas fa-clock"></i> Status: Not checked
                                    </div>
                                </div>
                            </div>

                            <!-- API Fallback -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-cloud"></i> API Fallback</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="deepseek-url" class="form-label">DeepSeek OCR URL</label>
                                        <input type="url" class="form-control" id="deepseek-url" name="deepseek_ocr_url" 
                                               value="{{ settings.get('deepseek_ocr_url', 'http://localhost:8001') }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="deepseek-api-key" class="form-label">API Key (if required)</label>
                                        <input type="password" class="form-control" id="deepseek-api-key" name="deepseek_api_key" 
                                               placeholder="Enter API key if required">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6><i class="fas fa-font"></i> Tesseract OCR (Fallback)</h6>
                            <div class="card">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="tesseract-path" class="form-label">Tesseract Path</label>
                                        <input type="text" class="form-control" id="tesseract-path" name="tesseract_path" 
                                               value="{{ settings.get('tesseract_path', '/usr/bin/tesseract') }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="tesseract-languages" class="form-label">Languages</label>
                                        <input type="text" class="form-control" id="tesseract-languages" name="tesseract_languages" 
                                               value="{{ settings.get('tesseract_languages', 'eng') }}" 
                                               placeholder="eng,fra,deu,spa">
                                        <div class="form-text">Comma-separated language codes</div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="testTesseractOCR()">
                                            <i class="fas fa-vial"></i> Test Tesseract
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="listTesseractLanguages()">
                                            <i class="fas fa-list"></i> List Languages
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="testOCRPipeline()">
                            <i class="fas fa-cogs"></i> Test Full OCR Pipeline
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save OCR Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- OnlyOffice Settings -->
    <div class="tab-pane fade" id="onlyoffice" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-file-office"></i> OnlyOffice Configuration</h5>
            </div>
            <div class="card-body">
                <form id="onlyoffice-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="onlyoffice-url" class="form-label">OnlyOffice Server URL</label>
                                <input type="url" class="form-control" id="onlyoffice-url" name="onlyoffice_url" 
                                       value="{{ settings.get('onlyoffice_url', 'http://localhost:8000') }}">
                            </div>
                            <div class="mb-3">
                                <label for="onlyoffice-secret" class="form-label">JWT Secret</label>
                                <input type="password" class="form-control" id="onlyoffice-secret" name="onlyoffice_secret" 
                                       placeholder="Enter JWT secret for security">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="onlyoffice-token" class="form-label">API Token</label>
                                <input type="password" class="form-control" id="onlyoffice-token" name="onlyoffice_token" 
                                       placeholder="Enter API token if required">
                            </div>
                            <div class="mb-3">
                                <label for="onlyoffice-storage" class="form-label">Storage URL</label>
                                <input type="url" class="form-control" id="onlyoffice-storage" name="onlyoffice_storage_url" 
                                       value="{{ settings.get('onlyoffice_storage_url', 'http://localhost:5000/storage') }}">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-sync" name="auto_sync_onlyoffice" 
                                   {{ 'checked' if settings.get('auto_sync_onlyoffice', False) else '' }}>
                            <label class="form-check-label" for="auto-sync">
                                Auto-sync documents to OnlyOffice after OCR
                            </label>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info" onclick="testOnlyOfficeConnection()">
                            <i class="fas fa-file-office"></i> Test Connection
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save OnlyOffice Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AI/LLM Settings -->
    <div class="tab-pane fade" id="ai" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-robot"></i> AI/LLM Configuration</h5>
            </div>
            <div class="card-body">
                <form id="ai-form">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>LLM Provider</h6>
                            <div class="mb-3">
                                <label for="llm-provider" class="form-label">Provider</label>
                                <select class="form-select" id="llm-provider" name="llm_provider">
                                    <option value="ollama" {{ 'selected' if settings.get('llm_provider') == 'ollama' else '' }}>Ollama (Local)</option>
                                    <option value="openai" {{ 'selected' if settings.get('llm_provider') == 'openai' else '' }}>OpenAI</option>
                                    <option value="anthropic" {{ 'selected' if settings.get('llm_provider') == 'anthropic' else '' }}>Anthropic</option>
                                    <option value="lm_studio" {{ 'selected' if settings.get('llm_provider') == 'lm_studio' else '' }}>LM Studio</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="llm-model" class="form-label">Model Name</label>
                                <div class="input-group">
                                    <select class="form-select" id="llm-model-select" name="llm_model_select">
                                        <option value="">Loading models...</option>
                                    </select>
                                    <input type="text" class="form-control" id="llm-model" name="llm_model" 
                                           value="{{ settings.get('llm_model', 'llama3.2:3b') }}" 
                                           placeholder="e.g., llama3.2:3b, gpt-4, claude-3">
                                    <button class="btn btn-outline-secondary" type="button" id="refresh-models-btn" title="Refresh Models">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">Select from dropdown or type custom model name</small>
                            </div>
                            <div class="mb-3">
                                <label for="llm-base-url" class="form-label">Base URL</label>
                                <input type="url" class="form-control" id="llm-base-url" name="llm_base_url" 
                                       value="{{ settings.get('llm_base_url', 'http://localhost:11434') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>API Configuration</h6>
                            <div class="mb-3">
                                <label for="llm-api-key" class="form-label">API Key</label>
                                <input type="password" class="form-control" id="llm-api-key" name="llm_api_key" 
                                       placeholder="Enter API key if required">
                            </div>
                            <div class="mb-3">
                                <label for="llm-temperature" class="form-label">Temperature</label>
                                <input type="number" class="form-control" id="llm-temperature" name="llm_temperature" 
                                       value="{{ settings.get('llm_temperature', '0.7') }}" 
                                       min="0" max="2" step="0.1">
                            </div>
                            <div class="mb-3">
                                <label for="llm-max-tokens" class="form-label">Max Tokens</label>
                                <input type="number" class="form-control" id="llm-max-tokens" name="llm_max_tokens" 
                                       value="{{ settings.get('llm_max_tokens', '2048') }}">
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info" onclick="testLLMConnection()">
                            <i class="fas fa-robot"></i> Test LLM
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save AI Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- System Settings -->
    <div class="tab-pane fade" id="system" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-server"></i> System Configuration</h5>
            </div>
            <div class="card-body">
                <form id="system-form">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Application Settings</h6>
                            <div class="mb-3">
                                <label for="app-name" class="form-label">Application Name</label>
                                <input type="text" class="form-control" id="app-name" name="app_name" 
                                       value="{{ settings.get('app_name', 'OCR Agent') }}">
                            </div>
                            <div class="mb-3">
                                <label for="upload-folder" class="form-label">Upload Folder</label>
                                <input type="text" class="form-control" id="upload-folder" name="upload_folder" 
                                       value="{{ settings.get('upload_folder', 'uploads') }}">
                            </div>
                            <div class="mb-3">
                                <label for="max-file-size" class="form-label">Max File Size (MB)</label>
                                <input type="number" class="form-control" id="max-file-size" name="max_file_size" 
                                       value="{{ settings.get('max_file_size', '16') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Security Settings</h6>
                            <div class="mb-3">
                                <label for="secret-key" class="form-label">Secret Key</label>
                                <input type="password" class="form-control" id="secret-key" name="secret_key" 
                                       placeholder="Enter new secret key to change">
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="debug-mode" name="debug_mode" 
                                           {{ 'checked' if settings.get('debug_mode', False) else '' }}>
                                    <label class="form-check-label" for="debug-mode">
                                        Debug Mode
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-backup" name="auto_backup" 
                                           {{ 'checked' if settings.get('auto_backup', True) else '' }}>
                                    <label class="form-check-label" for="auto-backup">
                                        Auto Backup Database
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-warning" onclick="exportSettings()">
                            <i class="fas fa-download"></i> Export Settings
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="importSettings()">
                            <i class="fas fa-upload"></i> Import Settings
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save System Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AI Prompts Settings -->
    <div class="tab-pane fade" id="prompts" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-magic"></i> AI Prompt Management</h5>
                <div>
                    <button type="button" class="btn btn-success btn-sm me-2" id="new-prompt-btn">
                        <i class="fas fa-plus me-1"></i>New Prompt
                    </button>
                    <button type="button" class="btn btn-info btn-sm me-2" onclick="resetAllPrompts()">
                        <i class="fas fa-undo me-1"></i>Reset All
                    </button>
                    <a href="{{ url_for('main.prompt_panel') }}" class="btn btn-primary btn-sm" target="_blank">
                        <i class="fas fa-external-link-alt me-1"></i>Full Editor
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Left Column - Prompt Categories -->
                    <div class="col-md-3">
                        <h6 class="fw-bold mb-3">Prompt Categories</h6>
                        <div class="list-group" id="prompt-categories">
                            <a href="#" class="list-group-item list-group-item-action active" data-category="system">
                                <i class="fas fa-robot me-2"></i>System
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="ocr">
                                <i class="fas fa-eye me-2"></i>OCR Analysis
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="chat">
                                <i class="fas fa-comments me-2"></i>Chat Assistant
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="analysis">
                                <i class="fas fa-search me-2"></i>Document Analysis
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="lesson">
                                <i class="fas fa-graduation-cap me-2"></i>Lesson Generator
                            </a>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="mt-3">
                            <h6 class="fw-bold mb-2">Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-success btn-sm" onclick="exportAllPrompts()">
                                    <i class="fas fa-download me-1"></i>Export All
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="importPrompts()">
                                    <i class="fas fa-upload me-1"></i>Import
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Middle Column - Prompt Editor -->
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Prompt Editor</h6>
                        <form id="prompt-editor-form">
                            <div class="mb-3">
                                <label for="prompt-name-settings" class="form-label fw-bold">Prompt Name</label>
                                <input type="text" class="form-control" id="prompt-name-settings" placeholder="Enter prompt name">
                            </div>
                            
                            <div class="mb-3">
                                <label for="prompt-description-settings" class="form-label fw-bold">Description</label>
                                <input type="text" class="form-control" id="prompt-description-settings" placeholder="Brief description">
                            </div>
                            
                            <div class="mb-3">
                                <label for="prompt-content-settings" class="form-label fw-bold">Prompt Content</label>
                                <textarea class="form-control" id="prompt-content-settings" rows="10" 
                                          placeholder="Enter your prompt content here..."></textarea>
                                <div class="form-text">
                                    <small>Use variables: {document_content}, {user_query}, {context}, {file_name}</small>
                                </div>
                            </div>
                            
                            <!-- Advanced Settings (Collapsible) -->
                            <div class="mb-3">
                                <button class="btn btn-outline-secondary btn-sm" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#advanced-settings">
                                    <i class="fas fa-cog me-1"></i>Advanced Settings
                                </button>
                            </div>
                            
                            <div class="collapse" id="advanced-settings">
                                <div class="card card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="temperature-settings" class="form-label">Temperature</label>
                                            <input type="range" class="form-range" id="temperature-settings" 
                                                   min="0" max="2" step="0.1" value="0.7">
                                            <small class="text-muted">Value: <span id="temp-value-settings">0.7</span></small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="max-tokens-settings" class="form-label">Max Tokens</label>
                                            <input type="number" class="form-control" id="max-tokens-settings" 
                                                   value="2048" min="100" max="8192">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="top-p-settings" class="form-label">Top P</label>
                                            <input type="range" class="form-range" id="top-p-settings" 
                                                   min="0" max="1" step="0.05" value="0.9">
                                            <small class="text-muted">Value: <span id="top-p-value-settings">0.9</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2 mt-3">
                                <button type="button" class="btn btn-primary" onclick="saveCurrentPrompt()">
                                    <i class="fas fa-save me-1"></i>Save Prompt
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetCurrentPrompt()">
                                    <i class="fas fa-undo me-1"></i>Reset
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="testCurrentPromptSettings()">
                                    <i class="fas fa-vial me-1"></i>Test
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Right Column - Variables & Preview -->
                    <div class="col-md-3">
                        <h6 class="fw-bold mb-3">Available Variables</h6>
                        <div class="mb-3">
                            <small class="text-muted d-block mb-2">Click to insert:</small>
                            <div class="d-flex flex-wrap gap-1">
                                <span class="badge bg-secondary clickable" onclick="insertVariableSettings('{user_query}')">
                                    {user_query}
                                </span>
                                <span class="badge bg-secondary clickable" onclick="insertVariableSettings('{document_content}')">
                                    {document_content}
                                </span>
                                <span class="badge bg-secondary clickable" onclick="insertVariableSettings('{context}')">
                                    {context}
                                </span>
                                <span class="badge bg-secondary clickable" onclick="insertVariableSettings('{file_name}')">
                                    {file_name}
                                </span>
                                <span class="badge bg-secondary clickable" onclick="insertVariableSettings('{ocr_text}')">
                                    {ocr_text}
                                </span>
                                <span class="badge bg-secondary clickable" onclick="insertVariableSettings('{timestamp}')">
                                    {timestamp}
                                </span>
                            </div>
                        </div>
                        
                        <h6 class="fw-bold mb-3">Test Area</h6>
                        <div class="mb-3">
                            <textarea class="form-control" id="test-input-settings" rows="4" 
                                      placeholder="Enter test input..."></textarea>
                        </div>
                        <button class="btn btn-warning btn-sm w-100 mb-3" onclick="runPromptTest()">
                            <i class="fas fa-play me-1"></i>Run Test
                        </button>
                        
                        <!-- Test Results -->
                        <div id="test-results-settings" class="p-3 bg-light rounded d-none">
                            <h6 class="fw-bold">Test Results:</h6>
                            <div id="test-output-settings" class="text-muted">
                                Results will appear here...
                            </div>
                        </div>
                        
                        <!-- Current Prompt Info -->
                        <div class="mt-3 p-3 bg-info bg-opacity-10 rounded">
                            <h6 class="fw-bold text-info">Current Prompt</h6>
                            <div id="current-prompt-info">
                                <small class="text-muted">Select a category to edit</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for settings import -->
<input type="file" id="settings-file-input" accept=".json" style="display: none;">

{% endblock %}

{% block scripts %}
<script>
// Form submission handlers
document.getElementById('database-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings('database', this);
});

document.getElementById('ocr-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings('ocr', this);
});

document.getElementById('onlyoffice-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveOnlyOfficeSettings(this);
});

document.getElementById('ai-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveAISettings(this);
});

document.getElementById('system-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings('system', this);
});

// Save AI settings function
function saveAISettings(form) {
    const formData = new FormData(form);
    const settings = {};
    
    for (let [key, value] of formData.entries()) {
        if (form.querySelector(`[name="${key}"]`).type === 'checkbox') {
            settings[key] = form.querySelector(`[name="${key}"]`).checked;
        } else {
            settings[key] = value;
        }
    }
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;
    
    fetch('/api/settings/ai', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('AI settings saved successfully! Connection: ' + data.connection_status, 'success');
        } else {
            showNotification('Error saving AI settings: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showNotification('Error saving AI settings: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Load Ollama models
function loadOllamaModels() {
    const modelSelect = document.getElementById('llm-model-select');
    const refreshBtn = document.getElementById('refresh-models-btn');
    
    // Show loading state
    modelSelect.innerHTML = '<option value="">Loading models...</option>';
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch('/api/ollama/models')
    .then(response => response.json())
    .then(data => {
        modelSelect.innerHTML = '<option value="">Select a model...</option>';
        
        if (data.success && data.models.length > 0) {
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${formatBytes(model.size)})`;
                modelSelect.appendChild(option);
            });
            
            // Set current model if it exists
            const currentModel = document.getElementById('llm-model').value;
            if (currentModel) {
                modelSelect.value = currentModel;
            }
            
            showNotification(`Loaded ${data.models.length} Ollama models`, 'success');
        } else {
            modelSelect.innerHTML = '<option value="">No models available</option>';
            showNotification(data.error || 'No Ollama models found', 'warning');
        }
    })
    .catch(error => {
        modelSelect.innerHTML = '<option value="">Error loading models</option>';
        showNotification('Error loading Ollama models: ' + error.message, 'danger');
    })
    .finally(() => {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
    });
}

// Helper function to format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Handle model selection
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('llm-model-select');
    const modelInput = document.getElementById('llm-model');
    const refreshBtn = document.getElementById('refresh-models-btn');
    const providerSelect = document.getElementById('llm-provider');
    
    // Load models when page loads
    if (providerSelect.value === 'ollama') {
        loadOllamaModels();
    }
    
    // Update input when selection changes
    modelSelect.addEventListener('change', function() {
        if (this.value) {
            modelInput.value = this.value;
        }
    });
    
    // Refresh models button
    refreshBtn.addEventListener('click', function() {
        if (providerSelect.value === 'ollama') {
            loadOllamaModels();
        }
    });
    
    // Show/hide model selector based on provider
    providerSelect.addEventListener('change', function() {
        const isOllama = this.value === 'ollama';
        modelSelect.style.display = isOllama ? 'block' : 'none';
        refreshBtn.style.display = isOllama ? 'block' : 'none';
        
        if (isOllama) {
            loadOllamaModels();
        }
    });
    
    // Initial provider check
    const isOllama = providerSelect.value === 'ollama';
    modelSelect.style.display = isOllama ? 'block' : 'none';
    refreshBtn.style.display = isOllama ? 'block' : 'none';
});

// Save OnlyOffice settings function
function saveOnlyOfficeSettings(form) {
    const formData = new FormData(form);
    const settings = {};
    
    for (let [key, value] of formData.entries()) {
        if (form.querySelector(`[name="${key}"]`).type === 'checkbox') {
            settings[key] = form.querySelector(`[name="${key}"]`).checked;
        } else {
            settings[key] = value;
        }
    }
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;
    
    fetch('/api/settings/onlyoffice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('OnlyOffice settings saved successfully! Connection: ' + data.connection_status, 'success');
        } else {
            showNotification('Error saving OnlyOffice settings: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showNotification('Error saving OnlyOffice settings: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Save settings function
function saveSettings(category, form) {
    const formData = new FormData(form);
    const settings = {};
    
    for (let [key, value] of formData.entries()) {
        if (form.querySelector(`[name="${key}"]`).type === 'checkbox') {
            settings[key] = form.querySelector(`[name="${key}"]`).checked;
        } else {
            settings[key] = value;
        }
    }
    
    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({category: category, settings: settings})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Settings saved successfully!', 'success');
        } else {
            showNotification('Error saving settings: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showNotification('Error: ' + error.message, 'danger');
    });
}

// Test connection functions
function testDatabaseConnection() {
    const statusElement = document.getElementById('db-connection-status');
    statusElement.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Testing...';
    statusElement.className = 'badge bg-warning';
    
    const form = document.getElementById('database-form');
    const formData = new FormData(form);
    const dbConfig = {};
    for (let [key, value] of formData.entries()) {
        dbConfig[key] = value;
    }
    
    fetch('/api/test-database', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dbConfig)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusElement.textContent = 'Connected';
            statusElement.className = 'badge bg-success';
        } else {
            statusElement.textContent = 'Failed: ' + data.error;
            statusElement.className = 'badge bg-danger';
        }
    })
    .catch(error => {
        statusElement.textContent = 'Error: ' + error.message;
        statusElement.className = 'badge bg-danger';
    });
}

function testOCRConnection() {
    fetch('/api/test-ocr', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('OCR services are working correctly!', 'success');
        } else {
            showNotification('OCR test failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showNotification('Error testing OCR: ' + error.message, 'danger');
    });
}

function testOnlyOfficeConnection() {
    // Get current form values
    const form = document.getElementById('onlyoffice-form');
    const formData = new FormData(form);
    const settings = {};
    
    for (let [key, value] of formData.entries()) {
        settings[key] = value;
    }
    
    // Show loading state on test button
    const testBtn = document.querySelector('button[onclick="testOnlyOfficeConnection()"]');
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    testBtn.disabled = true;
    
    fetch('/api/settings/test-onlyoffice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.connected) {
            showNotification('OnlyOffice connection successful! Service URL: ' + data.service_url, 'success');
        } else {
            showNotification('OnlyOffice connection failed: ' + (data.error || 'Service unavailable'), 'danger');
        }
    })
    .catch(error => {
        showNotification('Error testing OnlyOffice: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restore button state
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    });
}

function testLLMConnection() {
    fetch('/api/test-llm', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('LLM connection successful! Response: ' + data.response, 'success');
        } else {
            showNotification('LLM test failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showNotification('Error testing LLM: ' + error.message, 'danger');
    });
}

// DeepSeek OCR Management Functions
function startDeepSeekOCR() {
    showNotification('Starting DeepSeek OCR server...', 'info');
    
    fetch('/api/deepseek/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('DeepSeek OCR server started successfully!', 'success');
            updateDeepSeekStatus('running', 'Server is running');
        } else {
            showNotification('Failed to start DeepSeek OCR server: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error starting DeepSeek OCR:', error);
        showNotification('Error starting DeepSeek OCR server', 'error');
    });
}

function stopDeepSeekOCR() {
    showNotification('Stopping DeepSeek OCR server...', 'info');
    
    fetch('/api/deepseek/stop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('DeepSeek OCR server stopped successfully!', 'success');
            updateDeepSeekStatus('stopped', 'Server is stopped');
        } else {
            showNotification('Failed to stop DeepSeek OCR server: ' + data.message, 'warning');
        }
    })
    .catch(error => {
        console.error('Error stopping DeepSeek OCR:', error);
        showNotification('Error stopping DeepSeek OCR server', 'error');
    });
}

function checkDeepSeekStatus() {
    fetch('/api/deepseek/status')
    .then(response => response.json())
    .then(data => {
        const isRunning = data.is_running || false;
        const message = data.message || 'Status unknown';
        
        updateDeepSeekStatus(isRunning ? 'running' : 'stopped', message);
        
        if (data.server_info) {
            console.log('DeepSeek OCR Server Info:', data.server_info);
        }
    })
    .catch(error => {
        console.error('Error checking DeepSeek OCR status:', error);
        updateDeepSeekStatus('error', 'Failed to check status');
    });
}

function updateDeepSeekStatus(status, message) {
    const statusDiv = document.getElementById('deepseek-status');
    
    // Remove all status classes
    statusDiv.classList.remove('alert-success', 'alert-danger', 'alert-warning', 'alert-secondary');
    
    // Add appropriate class and icon
    switch(status) {
        case 'running':
            statusDiv.classList.add('alert-success');
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Status: ' + message;
            break;
        case 'stopped':
            statusDiv.classList.add('alert-warning');
            statusDiv.innerHTML = '<i class="fas fa-pause-circle"></i> Status: ' + message;
            break;
        case 'error':
            statusDiv.classList.add('alert-danger');
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Status: ' + message;
            break;
        default:
            statusDiv.classList.add('alert-secondary');
            statusDiv.innerHTML = '<i class="fas fa-question-circle"></i> Status: ' + message;
    }
}

function testTesseractOCR() {
    showNotification('Testing Tesseract OCR...', 'info');
    
    fetch('/api/ocr/test-tesseract', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Tesseract OCR test successful!', 'success');
        } else {
            showNotification('Tesseract OCR test failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error testing Tesseract OCR:', error);
        showNotification('Error testing Tesseract OCR', 'error');
    });
}

function listTesseractLanguages() {
    fetch('/api/ocr/tesseract-languages')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const languages = data.languages.join(', ');
            showNotification('Available languages: ' + languages, 'info');
        } else {
            showNotification('Failed to get Tesseract languages: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error getting Tesseract languages:', error);
        showNotification('Error getting Tesseract languages', 'error');
    });
}

function testOCRPipeline() {
    showNotification('Testing full OCR pipeline...', 'info');
    
    fetch('/api/ocr/test-pipeline', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = 'OCR Pipeline Test Results:\n';
            if (data.deepseek_local) message += ' DeepSeek Local: Working\n';
            if (data.deepseek_api) message += ' DeepSeek API: Working\n';
            if (data.tesseract) message += ' Tesseract: Working\n';
            
            showNotification(message, 'success');
        } else {
            showNotification('OCR Pipeline test failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error testing OCR pipeline:', error);
        showNotification('Error testing OCR pipeline', 'error');
    });
}

// Auto-check DeepSeek status on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check DeepSeek status after a short delay
    setTimeout(checkDeepSeekStatus, 1000);
});

// Settings import/export
function exportSettings() {
    fetch('/api/settings/export')
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'ocr_agent_settings.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('Settings exported successfully!', 'success');
    })
    .catch(error => {
        showNotification('Error exporting settings: ' + error.message, 'danger');
    });
}

function importSettings() {
    document.getElementById('settings-file-input').click();
}

document.getElementById('settings-file-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('settings_file', file);
        
        fetch('/api/settings/import', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Settings imported successfully! Reloading page...', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showNotification('Error importing settings: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showNotification('Error importing settings: ' + error.message, 'danger');
        });
    }
});

// Notification function
function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    testDatabaseConnection();
    
    // Handle URL hash navigation for direct tab access
    function activateTabFromHash() {
        const hash = window.location.hash.substring(1); // Remove the #
        if (hash) {
            const tabButton = document.querySelector(`#${hash}-tab`);
            const tabPane = document.querySelector(`#${hash}`);
            
            if (tabButton && tabPane) {
                // Remove active class from all tabs and panes
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                
                // Activate the target tab
                tabButton.classList.add('active');
                tabPane.classList.add('show', 'active');
                
                // Scroll to top of the page
                window.scrollTo(0, 0);
                
                // Show a notification about which section was opened
                const tabName = tabButton.textContent.trim();
                showNotification(`Opened ${tabName} settings`, 'info');
            }
        }
    }
    
    // Activate tab from hash on page load
    activateTabFromHash();
    
    // Listen for hash changes (if user uses back/forward buttons)
    window.addEventListener('hashchange', activateTabFromHash);
});

// Add debug mode flag
const DEBUG_MODE = true;

// Simple API connectivity test
function testAPIConnectivity() {
    console.log('Testing API connectivity...');
    
    return fetch('/api/prompts/')
        .then(response => {
            console.log('API test response:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API test success:', data);
            return true;
        })
        .catch(error => {
            console.error('API test failed:', error);
            showNotification('API connection failed: ' + error.message, 'danger');
            return false;
        });
}

// Prompt Management Functions
let currentPromptCategory = 'system';
let currentPromptData = null;

// Default prompt templates
const defaultPromptTemplates = {
    system: {
        name: "System Prompt",
        description: "Core AI behavior and personality",
        content: "You are a helpful AI assistant specialized in document analysis and OCR. You provide accurate, helpful responses based on the content of uploaded documents. Always be clear, concise, and professional in your responses."
    },
    ocr: {
        name: "OCR Analysis Prompt",
        description: "OCR text analysis and correction",
        content: "Analyze the following OCR extracted text and provide corrections, insights, and structure improvements:\n\n{ocr_text}\n\nFocus on:\n1. Accuracy and readability\n2. Identifying potential OCR errors\n3. Structural improvements\n4. Content understanding"
    },
    chat: {
        name: "Chat Assistant Prompt",
        description: "Interactive chat responses",
        content: "You are an intelligent document assistant. Answer user questions based on the provided document context:\n\nContext: {context}\nUser Question: {user_query}\n\nProvide a helpful, accurate response that directly addresses the question using the available context."
    },
    analysis: {
        name: "Document Analysis Prompt",
        description: "Deep document analysis and insights",
        content: "Perform a comprehensive analysis of the following document:\n\n{document_content}\n\nProvide insights on:\n1. Key topics and themes\n2. Important information and findings\n3. Document structure and organization\n4. Recommendations and next steps\n5. Summary of main points"
    },
    lesson: {
        name: "Lesson Generator Prompt",
        description: "Educational content creation",
        content: "Create comprehensive lesson notes based on the following content:\n\n{content}\n\nGenerate:\n1. Clear learning objectives\n2. Key concepts and definitions\n3. Detailed explanations with examples\n4. Practice activities and exercises\n5. Assessment questions\n6. Additional resources for further learning"
    }
};

function editPrompt(promptKey) {
    // Open the full prompt panel in a new tab with the specific prompt
    const url = `{{ url_for('main.prompt_panel') }}?edit=${promptKey}`;
    window.open(url, '_blank');
}

function resetAllPrompts() {
    if (confirm('This will reset all prompts to their default values. Are you sure?')) {
        fetch('/api/prompts/defaults', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('All prompts reset to defaults successfully!', 'success');
                loadPromptCategory(currentPromptCategory);
            } else {
                showNotification('Error resetting prompts: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error resetting prompts:', error);
            showNotification('Error resetting prompts', 'danger');
        });
    }
}

function exportAllPrompts() {
    fetch('/api/prompts/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const dataStr = JSON.stringify(data.prompts, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `ocr_agent_prompts_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Prompts exported successfully!', 'success');
        } else {
            showNotification('Error exporting prompts: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error exporting prompts:', error);
        showNotification('Error exporting prompts', 'danger');
    });
}

function importPrompts() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const prompts = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(prompts)) {
                        throw new Error('Invalid format: Expected array of prompts');
                    }
                    
                    // Save each prompt
                    const promises = prompts.map(prompt => {
                        return fetch('/api/prompts/save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                key: prompt.key || prompt.name?.toLowerCase().replace(/\s+/g, '_') + '_prompt',
                                value: prompt.value || prompt.content,
                                description: prompt.description
                            })
                        });
                    });
                    
                    Promise.all(promises)
                        .then(() => {
                            showNotification(`Imported ${prompts.length} prompts successfully!`, 'success');
                            loadPromptCategory(currentPromptCategory);
                        })
                        .catch(error => {
                            console.error('Import error:', error);
                            showNotification('Error importing some prompts', 'danger');
                        });
                        
                } catch (error) {
                    showNotification('Error importing prompts: Invalid JSON file', 'danger');
                }
            };
            reader.readAsText(file);
        }
    };
    input.click();
}

function testCurrentPromptSettings() {
    console.log('testCurrentPromptSettings called');
    const promptContent = document.getElementById('prompt-content-settings').value;
    const testInput = document.getElementById('test-input-settings').value;
    
    console.log('Prompt content:', promptContent);
    console.log('Test input:', testInput);
    
    if (!promptContent.trim()) {
        showNotification('Please enter prompt content first', 'warning');
        return;
    }
    
    if (!testInput.trim()) {
        showNotification('Please enter test input', 'warning');
        return;
    }
    
    // Show loading
    const resultsDiv = document.getElementById('test-results-settings');
    const outputDiv = document.getElementById('test-output-settings');
    resultsDiv.classList.remove('d-none');
    outputDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing prompt...';
    
    console.log('Making request to:', '/api/prompts/test');
    
    fetch('/api/prompts/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prompt: promptContent,
            sample_input: testInput
        })
    })
    .then(response => {
        console.log('Test response status:', response.status);
        console.log('Test response:', response);
        if (!response.ok) {
            console.error('Response not ok:', response.status, response.statusText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Test response data:', data);
        if (data.success) {
            const result = data.test_result;
            outputDiv.innerHTML = `
                <div class="text-success mb-2"><i class="fas fa-check-circle me-1"></i>Test Completed</div>
                <div><strong>Length:</strong> ${result.prompt_length} characters</div>
                <div><strong>Variables:</strong> ${result.has_variables ? 'Found' : 'None'}</div>
                <div class="mt-2"><strong>Status:</strong> Ready to use</div>
            `;
        } else {
            outputDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('Error testing prompt:', error);
        console.error('Error details:', error.message, error.stack);
        outputDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Network error: ${error.message}</div>`;
    });
}

function loadPromptCategory(category) {
    currentPromptCategory = category;
    
    // Update active category
    document.querySelectorAll('#prompt-categories .list-group-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.category === category) {
            item.classList.add('active');
        }
    });
    
    // Load prompt data from API or use defaults
    fetch('/api/prompts/')
    .then(response => {
        console.log('Load prompts response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Load prompts response data:', data);
        if (data.success) {
            const prompt = data.prompts.find(p => p.key === category + '_prompt') || 
                          data.prompts.find(p => p.key.includes(category));
            
            if (prompt) {
                loadPromptIntoEditor(prompt);
            } else {
                // Use default template
                const template = defaultPromptTemplates[category];
                if (template) {
                    loadPromptIntoEditor({
                        key: category + '_prompt',
                        value: template.content,
                        description: template.description,
                        name: template.name
                    });
                }
            }
        } else {
            console.warn('API returned success=false:', data);
            // Use default template
            const template = defaultPromptTemplates[category];
            if (template) {
                loadPromptIntoEditor({
                    key: category + '_prompt',
                    value: template.content,
                    description: template.description,
                    name: template.name
                });
            }
        }
    })
    .catch(error => {
        console.error('Error loading prompts:', error);
        showNotification('Could not load prompts from server, using defaults', 'warning');
        // Use default template
        const template = defaultPromptTemplates[category];
        if (template) {
            loadPromptIntoEditor({
                key: category + '_prompt',
                value: template.content,
                description: template.description,
                name: template.name
            });
        }
    });
}

function loadPromptIntoEditor(prompt) {
    currentPromptData = prompt;
    
    document.getElementById('prompt-name-settings').value = prompt.name || prompt.key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    document.getElementById('prompt-description-settings').value = prompt.description || '';
    document.getElementById('prompt-content-settings').value = prompt.value || '';
    
    // Update current prompt info
    const infoDiv = document.getElementById('current-prompt-info');
    infoDiv.innerHTML = `
        <div><strong>${prompt.name || 'Unnamed Prompt'}</strong></div>
        <small class="text-muted">${prompt.description || 'No description'}</small>
        <div class="mt-2">
            <small><strong>Length:</strong> ${(prompt.value || '').length} chars</small>
        </div>
    `;
}

function saveCurrentPrompt() {
    const name = document.getElementById('prompt-name-settings').value.trim();
    const description = document.getElementById('prompt-description-settings').value.trim();
    const content = document.getElementById('prompt-content-settings').value.trim();
    
    console.log('Save attempt:', { name, description, content: content.substring(0, 50) + '...' });
    
    if (!name) {
        showNotification('Please enter a prompt name', 'warning');
        return;
    }
    
    if (!content) {
        showNotification('Please enter prompt content', 'warning');
        return;
    }
    
    const promptKey = currentPromptData?.key || (currentPromptCategory + '_prompt');
    
    const promptData = {
        key: promptKey,
        value: content,
        description: description || `${name} - Custom prompt for ${currentPromptCategory}`
    };
    
    console.log('Sending prompt data:', promptData);
    
    // First test API connectivity
    testAPIConnectivity().then(apiWorking => {
        if (!apiWorking) {
            return; // Error already shown
        }
        
        fetch('/api/prompts/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(promptData)
        })
        .then(response => {
            console.log('Save response status:', response.status);
            console.log('Save response headers:', response.headers);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Save response data:', data);
            if (data.success) {
                showNotification('Prompt saved successfully!', 'success');
                
                // Update current prompt data
                if (currentPromptData) {
                    currentPromptData.value = content;
                    currentPromptData.description = description;
                    currentPromptData.name = name;
                }
                
                // Update the info display
                loadPromptIntoEditor({
                    key: promptKey,
                    value: content,
                    description: description,
                    name: name
                });
            } else {
                showNotification('Error saving prompt: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showNotification('Network error saving prompt: ' + error.message, 'danger');
        });
    });
}

function resetCurrentPrompt() {
    if (currentPromptData) {
        loadPromptIntoEditor(currentPromptData);
        showNotification('Prompt reset to last saved version', 'info');
    } else {
        loadPromptCategory(currentPromptCategory);
        showNotification('Prompt reset to default', 'info');
    }
}

function insertVariableSettings(variable) {
    const textarea = document.getElementById('prompt-content-settings');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(textarea.selectionEnd);
    
    textarea.value = textBefore + variable + textAfter;
    textarea.focus();
    textarea.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
    
    showNotification(`Inserted ${variable}`, 'info');
}

function runPromptTest() {
    testCurrentPromptSettings();
}

// Initialize prompt management when document loads
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for new prompt button
    const newPromptBtn = document.getElementById('new-prompt-btn');
    if (newPromptBtn) {
        newPromptBtn.addEventListener('click', function() {
            // Open prompt panel with new prompt flag
            const url = `{{ url_for('main.prompt_panel') }}?new=true`;
            window.open(url, '_blank');
        });
    }
    
    // Category selection handlers
    document.querySelectorAll('#prompt-categories .list-group-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const category = this.dataset.category;
            if (category) {
                loadPromptCategory(category);
            }
        });
    });
    
    // Range input handlers
    const tempRange = document.getElementById('temperature-settings');
    const topPRange = document.getElementById('top-p-settings');
    
    if (tempRange) {
        tempRange.addEventListener('input', function() {
            document.getElementById('temp-value-settings').textContent = this.value;
        });
    }
    
    if (topPRange) {
        topPRange.addEventListener('input', function() {
            document.getElementById('top-p-value-settings').textContent = this.value;
        });
    }
    
    // Load default system prompt on initialization
    setTimeout(() => {
        console.log('Initializing prompt management...');
        testAPIConnectivity().then(apiWorking => {
            if (apiWorking) {
                console.log('API working, loading system category');
                loadPromptCategory('system');
            } else {
                console.log('API not working, using defaults');
                const template = defaultPromptTemplates['system'];
                if (template) {
                    loadPromptIntoEditor({
                        key: 'system_prompt',
                        value: template.content,
                        description: template.description,
                        name: template.name
                    });
                }
            }
        });
    }, 500);
});
</script>
{% endblock %}